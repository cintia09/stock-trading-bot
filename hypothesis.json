{
  "date": "2026-02-16",
  "hypotheses": [
    {
      "id": "h-20260216-01",
      "5why_root": "仓位管理缺自动化：max_total_position=0.5参数已有，但无自动减仓触发。总仓位超限时只阻断买入，不主动卖出减仓",
      "action": "在run_trading_cycle的单只再平衡后，增加总仓位超限自动减仓逻辑：当总仓位>max_total_position时，按持仓占比从高到低逐只减仓，每只减到目标仓位为止",
      "target_file": "scripts/trading_engine.py",
      "target_function": "run_trading_cycle",
      "priority": 1,
      "patch": {
        "file": "trading_engine.py",
        "changes": [
          {
            "old": "    except Exception as e:\n        print(f\"\\n⚠️ [仓位再平衡异常] {e}\")\n\n    # 2. 获取市场情绪",
            "new": "    except Exception as e:\n        print(f\"\\n⚠️ [仓位再平衡异常] {e}\")\n\n    # 1.7 总仓位超限自动减仓：超过max_total_position时，按占比从高到低减\n    try:\n        account = load_account()\n        total_val = account.get(\"total_value\", 1000000)\n        available_cash = get_available_cash(account)\n        current_pos_pct = 1 - (available_cash / total_val) if total_val > 0 else 0\n        max_total = TRADING_RULES.get(\"max_total_position\", 0.50)\n        target_total = max_total - 0.02  # 减到比上限低2%，避免反复触发\n        if current_pos_pct > max_total + 0.01:  # 超限1%才触发，避免噪音\n            excess_value = (current_pos_pct - target_total) * total_val\n            print(f\"\\n⚖️ [总仓位减仓] 当前仓位{current_pos_pct*100:.1f}%>{max_total*100:.0f}%，需减¥{excess_value:.0f}\")\n            realtime_tp = fetch_realtime_sina([h[\"code\"] for h in account.get(\"holdings\", [])])\n            # 按持仓市值从高到低排序\n            holdings_sorted = []\n            for h in account.get(\"holdings\", []):\n                rt = realtime_tp.get(h[\"code\"], {})\n                price = rt.get(\"price\", h.get(\"current_price\", h[\"cost_price\"]))\n                mv = h[\"quantity\"] * price if price > 0 else 0\n                holdings_sorted.append((h, price, mv))\n            holdings_sorted.sort(key=lambda x: -x[2])\n            reduced = 0\n            for h, price, mv in holdings_sorted:\n                if reduced >= excess_value or price <= 0:\n                    break\n                sellable = can_sell_today(account, h[\"code\"])\n                if sellable < 100:\n                    continue\n                need_sell_value = min(excess_value - reduced, mv * 0.3)  # 每只最多减30%\n                sell_qty = int(need_sell_value / price / 100) * 100\n                sell_qty = min(sell_qty, sellable)\n                if sell_qty >= 100:\n                    print(f\"   减仓 {h['name']}({h['code']}) {sell_qty}股\")\n                    result = execute_trade(account, {\n                        \"code\": h[\"code\"],\n                        \"name\": h[\"name\"],\n                        \"price\": price,\n                        \"trade_type\": \"sell\",\n                        \"quantity\": sell_qty,\n                        \"reasons\": [f\"总仓位减仓: {current_pos_pct*100:.1f}%>{max_total*100:.0f}%\"]\n                    })\n                    if result[\"success\"]:\n                        reduced += sell_qty * price\n                        account = load_account()\n                    else:\n                        print(f\"   ⚠️ 减仓未执行: {result['reason']}\")\n            if reduced > 0:\n                print(f\"   ✅ 总仓位减仓完成，减少¥{reduced:.0f}\")\n    except Exception as e:\n        print(f\"\\n⚠️ [总仓位减仓异常] {e}\")\n\n    # 2. 获取市场情绪"
          }
        ]
      }
    }
  ]
}
